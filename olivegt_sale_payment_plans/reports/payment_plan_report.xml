<?xml version="1.0" encoding="UTF-8"?>
<odoo>
  <data>
    <!-- Acción de reporte -->
    <record id="action_report_payment_plan" model="ir.actions.report">
      <field name="name">Payment Plan</field>
      <field name="model">payment.plan</field>
      <field name="report_type">qweb-pdf</field>
      <field name="report_name">olivegt_sale_payment_plans.report_payment_plan</field>
      <field name="report_file">olivegt_sale_payment_plans.report_payment_plan</field>
      <field name="binding_model_id" ref="model_payment_plan"/>
      <field name="binding_type">report</field>
    </record>

    <record id="action_report_payment_plan_reconciliation_receipt" model="ir.actions.report">
      <field name="name">Payment Plan Receipt</field>
      <field name="model">payment.plan.reconciliation</field>
      <field name="report_type">qweb-pdf</field>
      <field name="report_name">olivegt_sale_payment_plans.report_payment_plan_reconciliation_receipt</field>
      <field name="report_file">olivegt_sale_payment_plans.report_payment_plan_reconciliation_receipt</field>
      <field name="binding_model_id" ref="model_payment_plan_reconciliation"/>
      <field name="binding_type">report</field>
    </record>

    <!-- Template QWeb -->
    <template id="report_payment_plan">
      <t t-call="web.html_container">
        <t t-foreach="docs" t-as="o">
          <t t-call="web.external_layout">
            <style>
                          <t t-set="price_with_tax" t-value="sol.price_unit"/>
                          <span t-esc="price_with_tax" t-options='{"widget":"monetary","display_currency":o.currency_id}'/>
              <!-- Cuotas -->
              <div class="section-title">DETALLE DE CUOTAS</div>
              <table class="table-condensed">
                <thead>
                  <tr>
                    <th>Cuota</th>
                    <th>Vence</th>
                    <th>Monto</th>
                    <th>Interes</th>
                    <th>Total</th>
                    <th>Pagado</th>
                    <th>Saldo</th>
                    <th>Pagos</th>
                  </tr>
                </thead>
                <tbody>
                  <t t-set="idx" t-value="0"/>
                  <t t-foreach="o.line_ids.sorted(key=lambda l: l.date)" t-as="line">
                    <t t-set="idx" t-value="idx + 1"/>
                    <tr>
                      <td class="text-center">
                        <t t-esc="line.name or 'Cuota ' + str(idx)"/>
                      </td>
                      <td class="text-center">
                        <span t-field="line.date" t-options='{"format":"dd/MM/yyyy"}'/>
                      </td>
                      <td class="text-right">
                        <span t-field="line.amount"
                              t-options='{"widget":"monetary","display_currency":o.currency_id}'/>
                      </td>
                      <td class="text-right">
                        <t t-if="line.interest_amount &gt; 0">
                          <span t-field="line.interest_amount"
                                t-options='{"widget":"monetary","display_currency":o.currency_id}'/>
                        </t>
                      </td>
                      <td class="text-right">
                        <span t-field="line.total_with_interest"
                              t-options='{"widget":"monetary","display_currency":o.currency_id}'/>
                      </td>
                      <td class="text-right">
                        <span t-field="line.allocated_amount"
                              t-options='{"widget":"monetary","display_currency":o.currency_id}'/>
                      </td>
                      <td class="text-right">
                        <t t-set="saldo_line" t-value="(line.total_with_interest or line.amount) - (line.allocated_amount or 0.0)"/>
                        <span t-esc="saldo_line" t-options='{"widget":"monetary","display_currency":o.currency_id}'/>
                      </td>
                      <td>
                        <t t-if="line.reconciliation_ids.filtered(lambda r: r.state=='confirmed')">
                          <div class="payments-container">
                            <t t-foreach="line.reconciliation_ids.filtered(lambda r: r.state=='confirmed')" t-as="rec">
                              <div class="payment-group">
                                <span class="payment-amount">
                                  <span t-field="rec.amount"
                                        t-options='{"widget":"monetary","display_currency":o.currency_id}'/>
                                </span>
                                <span class="payment-date">
                                  <span t-field="rec.date" t-options='{"format":"dd/MM/yyyy"}'/>
                                </span>
                                <span class="payment-ref" title="&lt;span t-esc=&quot;rec.move_payment_reference or rec.move_id.name&quot;/&gt;">
                                  <t t-esc="rec.move_payment_reference or rec.move_id.name"/>
                                </span>
                              </div>
                            </t>
                          </div>
                        </t>
                      </td>
                    </tr>
                  </t>
                </tbody>
              </table>

              <!-- Resumen de la Orden de Venta -->
              <div class="section-title">RESUMEN DE LA ORDEN DE VENTA</div>
              <t t-set="total_pagado" t-value="(o.total_amount or 0.0) - (o.amount_residual or 0.0)"/>
              <table class="summary-table">
                <tr>
                  <td><strong>Orden:</strong><br/><span t-field="o.sale_id.name"/></td>
                  <td><strong>Cliente:</strong><br/><span t-field="o.partner_id"/></td>
                  <td><strong>Moneda:</strong><br/><span t-field="o.currency_id"/></td>
                </tr>
              </table>

              <table class="table-condensed">
                <thead>
                  <tr>
                    <th>Inmueble</th>
                    <th>Descripción</th>
                    <th class="text-right">Precio</th>
                  </tr>
                </thead>
                <tbody>
                  <t t-foreach="o.sale_id.order_line" t-as="sol">
                    <t t-if="not sol.display_type">
                      <tr>
                        <td><span t-esc="sol.product_id.name or sol.name"/></td>
                        <td><span t-esc="sol.product_id.x_studio_descripcion"/></td>
                        <td class="text-right">
                          <t t-call="web.html_container">
                            <t t-foreach="docs" t-as="rec">
                              <t t-call="web.external_layout">
                                <style>
                                  @page { size: A4; margin: 0; }
                                  body { margin: 0; }
                                  .receipt-template {
                                    position: relative;
                                    width: 210mm;
                                    height: 297mm;
                                    background: url('/olivegt_sale_payment_plans/static/src/img/payment_plan_receipt_bg.png') no-repeat center top;
                                    background-size: 210mm 297mm;
                                    font-family: 'Lato','Helvetica',sans-serif;
                                    color: #000;
                                  }
                                  .receipt-field {
                                    position: absolute;
                                    font-size: 12px;
                                    line-height: 1.2;
                                  }
                                  .receipt-field.small { font-size: 10px; }
                                  .receipt-page-wrapper { position: relative; width: 210mm; height: 297mm; }
                                </style>

                                <div class="receipt-page-wrapper">
                                  <div class="receipt-template">
                                    <!-- Ajusta las coordenadas (top/left) según el diseño del PNG -->
                                    <div class="receipt-field" style="top: 48mm; left: 35mm; min-width: 120mm;">
                                      <span t-esc="rec.partner_id.display_name"/>
                                    </div>
                                    <div class="receipt-field" style="top: 48mm; left: 165mm;">
                                      <span t-field="rec.date" t-options='{"format":"dd/MM/yyyy"}'/>
                                    </div>

                                    <div class="receipt-field" style="top: 62mm; left: 35mm; min-width: 60mm;">
                                      <span t-esc="rec.payment_plan_id.name"/>
                                    </div>
                                    <div class="receipt-field" style="top: 62mm; left: 105mm; min-width: 60mm;">
                                      <span t-esc="rec.payment_plan_line_id.name or rec.payment_plan_line_id.display_name"/>
                                    </div>
                                    <div class="receipt-field" style="top: 62mm; left: 170mm;">
                                      <span t-esc="rec.move_payment_reference or rec.move_id.name"/>
                                    </div>

                                    <div class="receipt-field" style="top: 76mm; left: 35mm;">
                                      <span t-field="rec.move_line_id.account_id.display_name"/>
                                    </div>
                                    <div class="receipt-field" style="top: 76mm; left: 170mm;">
                                      <span t-field="rec.move_date" t-options='{"format":"dd/MM/yyyy"}'/>
                                    </div>

                                    <div class="receipt-field" style="top: 105mm; left: 40mm; font-size: 14px; font-weight: 600;">
                                      <span t-field="rec.amount" t-options='{"widget":"monetary","display_currency":rec.currency_id}'/>
                                    </div>

                                    <div class="receipt-field small" style="top: 130mm; left: 40mm; min-width: 140mm;">
                                      <span t-esc="rec.payment_plan_line_id.payment_plan_id.sale_id.name"/>
                                    </div>

                                    <div class="receipt-field small" style="top: 248mm; left: 40mm; min-width: 60mm; text-align: center;">
                                      ___________________________<br/>Entrega
                                    </div>
                                    <div class="receipt-field small" style="top: 248mm; left: 125mm; min-width: 60mm; text-align: center;">
                                      ___________________________<br/>Recibe
                                    </div>
                                  </div>
                                </div>
                              </t>
                            </t>
                          </t>
                  <th class="text-center">Descripción</th>
                  <th class="text-right">Importe</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="text-center"><span t-field="rec.move_date" t-options='{"format":"dd/MM/yyyy"}'/></td>
                  <td><span t-esc="rec.payment_plan_line_id.payment_plan_id.sale_id.name or rec.payment_plan_line_id.payment_plan_id.name"/></td>
                  <td class="text-right">
                    <span t-field="rec.amount" t-options='{"widget":"monetary","display_currency":rec.currency_id}'/>
                  </td>
                </tr>
              </tbody>
              <tfoot>
                <tr>
                  <th colspan="2" class="text-right">Total</th>
                  <th class="text-right">
                    <span t-field="rec.amount" t-options='{"widget":"monetary","display_currency":rec.currency_id}'/>
                  </th>
                </tr>
              </tfoot>
            </table>

            <div class="signature-block">
              <div class="signature-line">Entrega</div>
              <div class="signature-line">Recibe</div>
            </div>

            <div style="margin-top:12px; font-size:10px;">
              <em>Este documento es un comprobante interno generado automáticamente por el módulo de planes de pago.</em>
            </div>
          </div>
        </t>
      </t>
    </t>
  </template>

  <template id="report_payment_plan_reconciliation_receipt">
    <t t-call="web.html_container">
      <t t-foreach="docs" t-as="rec">
        <t t-call="web.external_layout">
          <style>
            @page { size: A4; margin: 0; }
            body { margin: 0; }
            .receipt-page-wrapper { position: relative; width: 210mm; height: 297mm; }
            .receipt-template {
              position: absolute;
              top: 0;
              left: 0;
              width: 210mm;
              height: 297mm;
              background: url('/olivegt_sale_payment_plans/static/src/img/payment_plan_receipt_bg.png') no-repeat center top;
              background-size: 210mm 297mm;
              font-family: 'Lato','Helvetica',sans-serif;
              color: #000;
            }
            .receipt-field {
              position: absolute;
              font-size: 12px;
              line-height: 1.2;
            }
            .receipt-field.small { font-size: 10px; }
          </style>

          <div class="receipt-page-wrapper">
            <div class="receipt-template">
              <div class="receipt-field" style="top: 48mm; left: 35mm; min-width: 120mm;">
                <span t-esc="rec.partner_id.display_name"/>
              </div>
              <div class="receipt-field" style="top: 48mm; left: 165mm;">
                <span t-field="rec.date" t-options='{"format":"dd/MM/yyyy"}'/>
              </div>

              <div class="receipt-field" style="top: 62mm; left: 35mm; min-width: 60mm;">
                <span t-esc="rec.payment_plan_id.name"/>
              </div>
              <div class="receipt-field" style="top: 62mm; left: 105mm; min-width: 60mm;">
                <span t-esc="rec.payment_plan_line_id.name or rec.payment_plan_line_id.display_name"/>
              </div>
              <div class="receipt-field" style="top: 62mm; left: 170mm;">
                <span t-esc="rec.move_payment_reference or rec.move_id.name"/>
              </div>

              <div class="receipt-field" style="top: 76mm; left: 35mm;">
                <span t-field="rec.move_line_id.account_id.display_name"/>
              </div>
              <div class="receipt-field" style="top: 76mm; left: 170mm;">
                <span t-field="rec.move_date" t-options='{"format":"dd/MM/yyyy"}'/>
              </div>

              <div class="receipt-field" style="top: 105mm; left: 40mm; font-size: 14px; font-weight: 600;">
                <span t-field="rec.amount" t-options='{"widget":"monetary","display_currency":rec.currency_id}'/>
              </div>

              <div class="receipt-field small" style="top: 130mm; left: 40mm; min-width: 140mm;">
                <span t-esc="rec.payment_plan_line_id.payment_plan_id.sale_id.name"/>
              </div>

              <div class="receipt-field small" style="top: 248mm; left: 40mm; min-width: 60mm; text-align: center;">
                ___________________________<br/>Entrega
              </div>
              <div class="receipt-field small" style="top: 248mm; left: 125mm; min-width: 60mm; text-align: center;">
                ___________________________<br/>Recibe
              </div>
            </div>
          </div>
        </t>
      </t>
    </t>
  </template>
  </data>
</odoo>

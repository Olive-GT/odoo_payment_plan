<?xml version="1.0" encoding="UTF-8"?>
<odoo>
  <data>
    <!-- Acción de reporte -->
    <record id="action_report_payment_plan" model="ir.actions.report">
      <field name="name">Payment Plan</field>
      <field name="model">payment.plan</field>
      <field name="report_type">qweb-pdf</field>
      <field name="report_name">olivegt_sale_payment_plans.report_payment_plan</field>
      <field name="report_file">olivegt_sale_payment_plans.report_payment_plan</field>
      <field name="binding_model_id" ref="model_payment_plan"/>
      <field name="binding_type">report</field>
    </record>

    <record id="action_report_payment_plan_reconciliation_receipt" model="ir.actions.report">
      <field name="name">Payment Plan Receipt</field>
      <field name="model">payment.plan.reconciliation</field>
      <field name="report_type">qweb-pdf</field>
      <field name="report_name">olivegt_sale_payment_plans.report_payment_plan_reconciliation_receipt</field>
      <field name="report_file">olivegt_sale_payment_plans.report_payment_plan_reconciliation_receipt</field>
      <field name="binding_model_id" ref="model_payment_plan_reconciliation"/>
      <field name="binding_type">report</field>
    </record>

    <!-- Template QWeb Plan de Pagos -->
    <template id="report_payment_plan">
      <t t-call="web.html_container">
        <t t-foreach="docs" t-as="o">
          <t t-call="web.external_layout">
            <style>
              /* Base (blanco y negro) */
              .page { font-family:'Lato','Helvetica',sans-serif; font-size:8px; color:#000; }
              .report-title    { text-align:center; font-size:12px; font-weight:600; margin-bottom:4px; }
              .report-subtitle { text-align:center; font-size:8px; margin-bottom:8px; }
              .section-title   { font-size:9px; font-weight:600; margin:12px 0 4px; }
              .footer-note     { text-align:center; font-size:7px; margin-top:10px; }

              /* Cabecera */
              .summary-table { width:100%; border-collapse:collapse; margin-bottom:8px; }
              .summary-table td, .summary-table th { padding:2px 4px; vertical-align:top; border:0.7pt solid #000 !important; background:#fff !important; }
              .summary-table strong { font-weight:600; }

              /* Tablas (líneas delgadas) */
              .table-condensed { width:100%; border-collapse:collapse; }
              .table-condensed th,
              .table-condensed td { border:0.7pt solid #000 !important; padding:4px 6px; vertical-align:middle; background:#fff !important; }
              .table-condensed thead th { font-weight:600; text-align:center; border:0.7pt solid #000 !important; background:#fff !important; }
              .table-condensed tfoot td { border:0.7pt solid #000 !important; background:#fff !important; }
              .table-condensed tbody tr:nth-child(odd),
              .table-condensed tbody tr:nth-child(even) { background:#fff !important; }
              .table-condensed .text-right { text-align:right; }
              .table-condensed .text-center { text-align:center; }

              /* Pagos (única zona con color permitida) */
              .payments-container { display:flex; flex-direction:column; gap:1px; }
              .payment-group { display:flex; align-items:center; gap:6px; padding:0; background:transparent; color:#000; border:0; border-radius:0; }
              .payment-group span { padding:0 2px; font-size:7px; white-space:nowrap; }
              .payment-amount { flex:none; text-align:left; font-weight:600; }
              .payment-date   { flex:none; text-align:center; }
              .payment-ref    { flex:1; text-align:left; overflow:hidden; text-overflow:ellipsis; }

              /* Utilidades */
              .text-center { text-align:center; }
              .text-right  { text-align:right; }
            </style>

            <div class="page">
              <!-- Título -->
              <div class="report-title">ESTADO DE CUENTA</div>
              <div class="report-subtitle">Plan de Pagos: <span t-field="o.name"/></div>

              <!-- Resumen -->
              <table class="summary-table">
                <tr>
                  <td><strong>Cliente:</strong><br/><span t-field="o.partner_id"/></td>
                  <td><strong>Orden:</strong><br/><span t-field="o.sale_id.name"/></td>
                  <td><strong>Fecha:</strong><br/>
                    <span t-esc="format_date(o.env, today, lang_code=o.partner_id.lang or o.env.user.lang)"/>
                  </td>
                </tr>
                <tr>
                  <td><strong>Inmuebles:</strong><br/>
                    <t t-foreach="o.sale_id.order_line.filtered(lambda l: not l.display_type and l.product_id)" t-as="line">
                      <span t-esc="line.product_id.name"/><t t-if="not line_last">, </t>
                    </t>
                  </td>
                  <td><strong>Total Orden:</strong><br/>
                    <span t-esc="('%s %s' % (o.currency_id.symbol or '', '{:,.2f}'.format((o.sale_id.amount_total or 0.0))))"/>
                  </td>
                  <td><strong>Saldo:</strong><br/>
                    <span t-esc="('%s %s' % (o.currency_id.symbol or '', '{:,.2f}'.format((o.amount_residual or 0.0))))"/>
                  </td>
                </tr>
              </table>

              <!-- Cuotas -->
              <div class="section-title">DETALLE DE CUOTAS</div>
              <table class="table-condensed">
                <thead>
                  <tr>
                    <th>Cuota</th>
                    <th>Vence</th>
                    <th>Monto</th>
                    <th>Interes</th>
                    <th>Total</th>
                    <th>Pagado</th>
                    <th>Saldo</th>
                    <th>Pagos</th>
                  </tr>
                </thead>
                <tbody>
                  <t t-set="idx" t-value="0"/>
                  <t t-foreach="o.line_ids.sorted(key=lambda l: l.date)" t-as="line">
                    <t t-set="idx" t-value="idx + 1"/>
                    <tr>
                      <td class="text-center">
                        <t t-esc="line.name or 'Cuota ' + str(idx)"/>
                      </td>
                      <td class="text-center">
                        <span t-field="line.date" t-options='{"format":"dd/MM/yyyy"}'/>
                      </td>
                      <td class="text-right">
                        <span t-esc="('%s %s' % (o.currency_id.symbol or '', '{:,.2f}'.format((line.amount or 0.0))))"/>
                      </td>
                      <td class="text-right">
                        <t t-if="line.interest_amount &gt; 0">
                          <span t-esc="('%s %s' % (o.currency_id.symbol or '', '{:,.2f}'.format((line.interest_amount or 0.0))))"/>
                        </t>
                      </td>
                      <td class="text-right">
                        <span t-esc="('%s %s' % (o.currency_id.symbol or '', '{:,.2f}'.format((line.total_with_interest or 0.0))))"/>
                      </td>
                      <td class="text-right">
                        <span t-esc="('%s %s' % (o.currency_id.symbol or '', '{:,.2f}'.format((line.allocated_amount or 0.0))))"/>
                      </td>
                      <td class="text-right">
                        <t t-set="saldo_line" t-value="(line.total_with_interest or line.amount or 0.0) - (line.allocated_amount or 0.0)"/>
                        <span t-esc="('%s %s' % (o.currency_id.symbol or '', '{:,.2f}'.format(saldo_line)))"/>
                      </td>
                      <td>
                        <t t-if="line.reconciliation_ids.filtered(lambda r: r.state=='confirmed')">
                          <div class="payments-container">
                            <t t-foreach="line.reconciliation_ids.filtered(lambda r: r.state=='confirmed')" t-as="rec">
                              <div class="payment-group">
                                <span class="payment-amount">
                                  <span t-esc="('%s %s' % (rec.currency_id.symbol or '', '{:,.2f}'.format((rec.amount or 0.0))))"/>
                                </span>
                                <span class="payment-date">
                                  <span t-field="rec.date" t-options='{"format":"dd/MM/yyyy"}'/>
                                </span>
                                <span class="payment-ref" title="&lt;span t-esc=&quot;rec.move_payment_reference or rec.move_id.name&quot;/&gt;">
                                  <t t-esc="rec.move_payment_reference or rec.move_id.name"/>
                                </span>
                              </div>
                            </t>
                          </div>
                        </t>
                      </td>
                    </tr>
                  </t>
                </tbody>
              </table>

              <!-- Resumen de la Orden de Venta -->
              <div class="section-title">RESUMEN DE LA ORDEN DE VENTA</div>
              <t t-set="total_pagado" t-value="(o.total_amount or 0.0) - (o.amount_residual or 0.0)"/>
              <table class="summary-table">
                <tr>
                  <td><strong>Orden:</strong><br/><span t-field="o.sale_id.name"/></td>
                  <td><strong>Cliente:</strong><br/><span t-field="o.partner_id"/></td>
                  <td><strong>Moneda:</strong><br/><span t-field="o.currency_id"/></td>
                </tr>
              </table>

              <table class="table-condensed">
                <thead>
                  <tr>
                    <th>Inmueble</th>
                    <th>Descripción</th>
                    <th class="text-right">Precio</th>
                  </tr>
                </thead>
                <tbody>
                  <t t-foreach="o.sale_id.order_line" t-as="sol">
                    <t t-if="not sol.display_type">
                      <tr>
                        <td><span t-esc="sol.product_id.name or sol.name"/></td>
                        <td><span t-esc="sol.product_id.x_studio_descripcion"/></td>
                        <td class="text-right">
                          <t t-set="price_with_tax" t-value="sol.price_unit"/>
                          <span t-esc="('%s %s' % (o.currency_id.symbol or '', '{:,.2f}'.format((price_with_tax or 0.0))))"/>
                        </td>
                      </tr>
                    </t>
                  </t>
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="2" class="text-right"><strong>Total Orden</strong></td>
                    <td class="text-right">
                      <span t-esc="('%s %s' % (o.currency_id.symbol or '', '{:,.2f}'.format((o.sale_id.amount_total or 0.0))))"/>
                    </td>
                  </tr>
                  <tr>
                    <td colspan="2" class="text-right"><strong>Total Pagado</strong></td>
                    <td class="text-right"><span t-esc="('%s %s' % (o.currency_id.symbol or '', '{:,.2f}'.format((total_pagado or 0.0))))"/></td>
                  </tr>
                  <tr>
                    <td colspan="2" class="text-right"><strong>Total Pendiente</strong></td>
                    <td class="text-right"><span t-esc="('%s %s' % (o.currency_id.symbol or '', '{:,.2f}'.format((o.amount_residual or 0.0))))"/></td>
                  </tr>
                </tfoot>
              </table>

              <!-- Pie -->
              <div class="footer-note">
                <p>Documento informativo, no representa comprobante fiscal.</p>
              </div>
            </div>
          </t>
        </t>
      </t>
    </template>

    <!-- Template QWeb Recibo de Conciliación -->
    <template id="report_payment_plan_reconciliation_receipt">
      <t t-call="web.html_container">
        <t t-foreach="docs" t-as="rec">
          <t t-call="web.basic_layout">
            <style>
              body { margin: 0; }
              .receipt-template {
                position: absolute;
                top: 0mm;
                left: 0;
                width: 220mm;
                height: 100mm;
                background: url('https://storage.googleapis.com/pale-public-images/payment_plan_receipt_bg.png') no-repeat left top;
                background-size: 220mm 100mm;
                font-family: 'Lato','Helvetica',sans-serif;
                color: #000;
              }
              .receipt-field {
                position: absolute;
                font-size: 12px;
                line-height: 1.2;
              }
              .receipt-field.small { font-size: 10px; }
              .receipt-field.amount-words { text-transform: uppercase; }
              .receipt-field.reference {
                font-size: 16px;
                font-weight: 700;
                color: #b30000;
              }
            </style>

            <div class="receipt-page-wrapper">
              <div class="receipt-template">
                <div class="receipt-field" style="top: 30mm; left: 30mm; width: 70mm;">
                  <span t-field="rec.date" t-options="{&quot;format&quot;:&quot;dd/MM/yyyy&quot;}"/>
                </div>
                <div class="receipt-field" style="top: 30mm; left: 110mm; width: 55mm;">
                  <t t-if="rec.payment_plan_id.sale_id">
                    <t t-foreach="rec.payment_plan_id.sale_id.order_line.filtered(lambda l: not l.display_type and l.product_id)" t-as="line">
                      <span t-esc="line.product_id.default_code or line.product_id.name"/>
                      <t t-if="not line_last">, </t>
                    </t>
                  </t>
                </div>

                <div class="receipt-field" style="top: 40mm; left: 40mm; width: 120mm;">
                  <span t-esc="rec.partner_id.display_name"/>
                </div>

                <div class="receipt-field amount-words" style="top: 50mm; left: 40mm; width: 120mm;">
                  <span t-esc="rec.get_amount_in_words_plural()"/>
                </div>

                <div class="receipt-field" style="top: 35mm; left: 155mm; width: 35mm; text-align: right; font-weight: 600;">
                  <span t-esc="('%s %s' % (rec.currency_id.symbol or '', '{:,.2f}'.format((rec.amount or 0.0))))"/>
                </div>

                <div class="receipt-field" style="top: 60mm; left: 40mm; width: 120mm;">
                  <span t-esc="rec.payment_plan_line_id.name or rec.payment_plan_id.name"/>
                </div>

                <div class="receipt-field reference" style="top: 73mm; left: 140mm; width: 70mm; height: 30mm; text-align: center;">
                  <span t-esc="rec.move_payment_reference or rec.move_id.name or ''"/>
                </div>
              </div>
            </div>
          </t>
        </t>
      </t>
    </template>
  </data>
</odoo>
